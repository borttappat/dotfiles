#                    __               __   __                      __
# .-----.-----.-----|  |_.-----.-----|  |_|__.-----.-----.  .-----|__.--.--.
# |  _  |  -__|     |   _|  -__|__ --|   _|  |     |  _  |__|     |  |_   _|
# |   __|_____|__|__|____|_____|_____|____|__|__|__|___  |__|__|__|__|__.__|
# |__|                                             |_____|

{ config, pkgs, lib, ... }:

{

system.activationScripts.pentest-repos = ''
    TOOLS_DIR="/home/traum/tools"

    mkdir -p "$TOOLS_DIR"

    if [ ! -d "$TOOLS_DIR/Havoc ]; then
        ${pkgs.git}/bin/git clone   https://github.com/HavocFramework/Havoc "$TOOLS_DIR/Havoc"
    fi
    if [ ! -d "$TOOLS_DIR/SharpCollection ]; then
        ${pkgs.git}/bin/git clone  https://github.com/Flangvik/SharpCollection "$TOOLS_DIR/SharpCollection"
    fi
    
    if [ ! -d "$TOOLS_DIR/CS-Situational-Awareness-BOF" ]; then
        ${pkgs.git}/bin/git clone https://github.com/trustedsec/CS-Situational-Awareness-BOF "$TOOLS_DIR/CS-Situational-Awareness-BOF"
    fi

    if [ ! -d "$TOOLS_DIR/nanodump" ]; then
        ${pkgs.git}/bin/git clone https://github.com/fortra/nanodump "$TOOLS_DIR/nanodump"
    fi

    if [ ! -d "$TOOLS_DIR/donut" ]; then
        ${pkgs.git}/bin/git clone https://github.com/TheWover/donut "$TOOLS_DIR/donut"
    fi

  chown -R traum:users "$TOOLS_DIR"
'';

# Disable automatic time synchronization services
  services.timesyncd.enable = lib.mkForce false;
  services.ntp.enable = lib.mkForce false;  # Correct option path

system.activationScripts.wordlists = ''
  # Create wordlists directory for the user
  mkdir -p /home/traum/wordlists

  # Link to the wordlists package location
  ln -sfn $(${pkgs.wordlists}/bin/wordlists_path) /home/traum/wordlists/all

  # Set proper ownership
  chown -R traum:users /home/traum/wordlists
'';

# Packages to install on a system-wide level
    environment.systemPackages = with pkgs; [
    # Create the pentest-time script as a proper package
    (pkgs.writeShellScriptBin "pentest-time" ''
  #!/usr/bin/env bash
  
  # Script to manage system time during pentests
  # Usage: 
  #   sudo pentest-time -t <target_ip>
  #   sudo pentest-time -r
  
  set -e
  
  function print_usage {
    echo "Usage:"
    echo "  sudo $0 -t <target_ip>    # Set time to match target"
    echo "  sudo $0 -r                # Restore time from public NTP servers"
    echo "  sudo $0 -i                # Show current time information"
    echo ""
    echo "Example:"
    echo "  sudo $0 -t 10.10.11.41"
    exit 1
  }
  
  # Check if running as root
  if [ "$EUID" -ne 0 ]; then
    echo "Please run as root (sudo)"
    exit 1
  fi
  
  # Parse arguments
  if [ "$#" -lt 1 ]; then
    print_usage
  fi
  
  case "$1" in
    -t|--target)
      if [ -z "$2" ]; then
        echo "Error: Target IP address required"
        print_usage
      fi
      echo "Setting time to match target: $2"
      
      # Try to manually set time using date command if ntpdate fails
      if ! ${pkgs.ntp}/bin/ntpdate -s "$2" 2>/dev/null; then
        echo "NTP sync failed. Attempting manual time adjustment..."
        # Get target time using rdate if available
        if command -v rdate &>/dev/null; then
          TARGET_TIME=$(rdate -p $2 2>/dev/null)
          if [ $? -eq 0 ]; then
            date -s "$TARGET_TIME"
            echo "Time set manually to: $(date)"
          else
            echo "Warning: Failed to get time from target. Using current time on target for reference only."
          fi
        else
          echo "Warning: Unable to set time automatically. You may need to set it manually."
        fi
      else
        echo "Time set successfully to: $(date)"
      fi
      ;;
      
    -r|--restore)
      echo "Restoring time from public NTP servers..."
      if ${pkgs.ntp}/bin/ntpdate -s pool.ntp.org 2>/dev/null || ${pkgs.ntp}/bin/ntpdate -s time.google.com 2>/dev/null; then
        echo "Time restored successfully to: $(date)"
      else
        echo "Error: Failed to sync with public NTP servers."
        echo "You may need to rebuild your system to fully restore NixOS time settings:"
        echo "  sudo nixos-rebuild switch"
      fi
      ;;
      
    -i|--info)
      echo "Current time information:"
      echo "=========================="
      echo "Current time: $(date)"
      echo "Current timezone: $(timedatectl show --property=Timezone --value)"
      echo "Hardware clock time: $(hwclock --show 2>/dev/null || echo 'Not available')"
      ;;
      
    *)
      print_usage
      ;;
  esac
'')

    # Add ntp and tzdata for the time management script
    ntp
    tzdata

#(pkgs.callPackage ../burpsuite-pro.nix {})

    wordlists

# Pentesting
    
    openvpn

    dirb            #web content scanner
    whatweb         #web scanning tool
    gobuster        #Web directory scanner
    monsoon         #HTTP-enumerator
    #dirstalk
    feroxbuster     #dirbuster-alike tool

    #firefox_decrypt #Tool to extract passwords from profiles of Mozilla Firefox and derivates

    dalfox          #XSS-scanner
    #xsser           #XSS-scanner
    snmpcheck       #SNMP-enumerator
    net-snmp        #SNMP-enumerator
    braa            #SNMP-scanner
    onesixtyone     #SNMP-scanner

    enum4linux-ng   #SMB-scanner
    smbmap          #smb-enumeration tool

    python312Packages.impacket  #impacket
    python312Packages.bloodyad  #bloodyad
    python312Packages.pyftpdlib #ftp-library for python
    python312Packages.roadrecon #road-recon

    certipy

    mitmproxy       #Man-in-the-middle Proxy
    unstable.burpsuite
    mitmproxy2swagger
    #caido          #Burpsuite-like tool
    bettercap      #swiss army knife mitm-tool
    websploit       #MITM-framework


    openldap
    ldapdomaindump
    bloodhound-py
    #bloodhound
    autobloody     #automatically explioit AD privesc paths
    silenthound     #lightweight tool to enumerate AD enviroments
    #ad-miner        #AD audit tool
    adalanche       #AD ACL Visualizer and explorer
    kerbrute        #kerberos bruteforce utility

    responder
    #commix         #command injection exploitation tool
    #webanalyze     #similar to wapalyzer
    nikto           #scanner for website vulnerabilities
    nmap            #network-scanner
    rustscan        #nmap-alike tool written in rust
    chisel          #network pivoting tool

    #kismet         #wifi, bluetooth and RF-sniffer
    wireshark       #packet analysis and sniffer tool
    fping
    tcpdump         #network-sniffer
    tshark          #WireShark from the terminal
    #credslayer      #extract credentials and other useful info from network captures
    termshark
    #crackmapexec    #tool for pentesting networks, removed from repo and repaced by netexec
    netexec

    uncover         #API wrapper to scan for exposed hosts(shodan-ish)
    sherlock        #OSINT username tracker
    theharvester    #OSINT recon tool
    trufflehog      #Find credentials
    maltego         #OSINT recon tool

    dig             #domain name server

    hydra-cli       #thc-hydra cli program
    #python312Packages.patator #bnrute-forcing tool
    thc-hydra       #network-logon cracker
    #medusa         #login brute-forcer
    crowbar         #brute-forcing tool

    hash-identifier
    hashid
    hashcat         #password-cracker
    ocl-icd
    zlib
    opencl-headers
    john            #password/hash-cracker
    ophcrack-cli    #password-cracker using rainbowtables
    
    

    crunch          #Wordlist-generator
    cewl           #wordlist-generation tool
    rsmangler       #wordlist-manipulation tool
    username-anarchy    #username-list manipulation tool

    creds           #Tool for searching collections of default creds

    unstable.metasploit      #All-in-one exploit tool
    sqlmap          #SQL Injection tool
    pysqlrecon      #Offensive MSSQL toolkit
    evil-winrm      #WinRM shell generator
    #laudanum

    mimikatz        #Windows Security tool
    powersploit

    ghost           #Android exploitation framework

    rustcat         #netcat-replacement written in rust
    snicat          
    #pwncat          #netcat with persistent shell

    bully           #WPA/WPA2 Password recovery from WPS-enabled access point
    cowpatty        #offline dictionary attack tool against WPA/WPA2-networks
    aircrack-ng
    airgeddon       #All-in-one network hacking tool
    wifite2         #TUI Wifi attack software
    #stablePkgs.mdk4            #injection tool for wireless networks
    hcxdumptool     #packet-capture tool from wlan devices
    hcxtools
    pixiewps        #ffline WPS Brute-forcing

    samba
    #awscli2
    exploitdb       #searchsploit
    redis
    mariadb
    sqsh            #mssql/mysql-client
    freetds


    wprecon         #WordPress vulnerability scanner
    wpscan

    #routersploit    #embedded device exploitation framework

    #sleuthkit      #data recovery tool
    foremost        #file recovery tool
    binwalk
    testdisk        #data recovery tool


    dbmonster       #wifi-strength scanner
    linux-router    #wifi-hotspot/Proxy using a single command
    hostapd-mana    #rogue access point tool

    exiftool
    steghide        #extract data from images
    stegseek
    stegsolve
    zsteg
    pngcheck
    outguess
    aeskeyfind      #Locates 128-bit and 256-bit AES keys in a captured memory image

    #parsero        #audit tool for robots.txt
    reaverwps       #wifi brute-forcing tool
    reaverwps-t6x
    dnsrecon        #DNS enumeration tool
    dnsx            #yet another DNS enum tool
    subfinder
    macchanger      #tool for spoofing MAC-address
    dnsenum         #DNS enumeration tool
    fierce          #DNS enumeration tool
    amass           #Actively maintained tool focused on subdomain discovery, known for its integration with other tools and extensive data sources.

    wfuzz           #web fuzzing tool
    ffuf

    nfs-utils       #nfs-related tools
    openssl         

    ssh-audit       #SSH auditing tool

    #remmina
    #xrdp

    wafw00f         #firewall fingerprintig tool

    zap             #web application scanner

    medusa          #brute forcing tool for ftp

    rpcbind         #RPC portmapper

    nbtscan         #NetBIOS scanner
    nbtscanner      #Rust rework

    firewalk        # ACL-scanner

    # Encoding/Packing
    upx             #Ultimate Packer for eXecuteables

    go365           #Office365 enumeration tool

    swaks           #Featureful, flexible, scriptable, transaction-oriented SMTP test tool

    updog           #replacement for Python's SimpleHTTPServer

    ghidra          #Reverse engineering toolkit
    #ilspycmd        #Tool for decompiling .NET Assemblies and generating portable PBDs
    avalonia-ilspy

    freerdp3        #RDP-tool

    #cloudfox       #Cloud-pentesting toolset

    corkscrew       #proxychains-alike something something
    sshuttle        #Transparent proxy server that works as a poor man's VPN
    
    pkgsCross.mingwW64.buildPackages.gcc

];

# Services

services.mysql = {
    enable = true;
    package = pkgs.mariadb;
};

}
